# Python Api Tests Example

Demo проект на **pytest + allure** с заложенной структурой директорий и базовыми библиотеками.

**Зачем?** - Сократить время на подготовку проекта автотестов, унифицировать архитектуру и набор зависимостей.

## Требования

1. Python 3.7+
2. [Allure (не путать с зависимостью allure-pytest)](https://github.com/allure-framework/allure2)

## Установка

1. В директории проекта создаем venv
    ```
    python3 -m venv venv
    ```
2. Активируем venv:
    ```
    source venv/bin/activate
    ```
3. Устанавливаем зависимости:
    ```
    pip install -r ./requirements.txt
    ```

## Использование (демо тесты)

В качестве демо реализовано два теста:

- API (httpx mock) - проверка создания объекта из модели по http с валидацией полученной модели (созданный объект ==
  полученный объект).
- DB (table in memory) - проверка получения существующего объекта из базы по модели (созданный объект == полученный
  объект).

Запуск:

   ```
   pytest && allure serve allure_report
   ```

## Параметризация тестов

1. Параметризация запуска pytes осуществляется через [pytest.ini](pytest.ini).
2. Конфигурация проекта тестов (удаленные хосты, данные для авторизации) в [configs](./configs/) может быть
   указана/переопределена через переменные окружения при помощи
   команды: ``export varaible_name=variable_value``, однако, это захламляет окружение и может иметь долгосрочное влияние
   на
   запускаемы тесты (мало кто из env удаляет значения).

   Во избежание вышеописанной ситуации, предлагается использовать .env файл в корневой директории проекта (нужно создать
   и не добавлять в git) :
   ```bash
      db_user='actual_user'
      db_password='actual_password'
   ```

   Таким образом переменные из файлов не попадут в общий env и повлияют только на соотв. запуск тестов.

## Логирование

Реализовано расширенное логирование на основе [logging.json](./configs/logging.json) с пробросом записей в allure при наличии включенного одноименного handler'a в логере (включен по умолчанию).

```...
  "root": {
    "level": "INFO",
    "handlers": [
      "allure"
    ]
```

Все методы, добавляющие соотв. записи в allure report реализованы в [logger.py](./libs/logger.py) и содержат контекстный
менеджер ``allure.step`` за счет чего обеспечивается требуемая вложенность записей.

**Внимание**: реализовывать собственные методы/декораторы логирования стоит так, чтобы при отсутствии allure handler'a
не добавлялось нежелательных артефактов в отчет.
